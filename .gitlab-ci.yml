default:
  tags:
    - CI_SAST

image: tiangolo/docker-with-compose:latest

stages:
- test

integration_backend_tests:
  services:
   - name: docker:dind
     alias: dockerhost

  variables:
    DOCKER_HOST: tcp://dockerhost:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""

  stage: test
  before_script:
    - echo dockerhost
    # build and up BillRun app
    - cd docker/billrun-docker
    - docker-compose -f docker-compose-php74.yml build
    - docker-compose -f docker-compose-php74.yml up -d
    - cd $CI_PROJECT_DIR/integration_tests/
    - echo ENV = http://dockerhost:8074 > .env
    # create test virtual env
    - python3 --version  # For debugging
    - pip3 install --ignore-installed distlib virtualenv
    - python3 -m venv venv
    - source venv/bin/activate
    - pip3 install -e .
  script:
    - pytest -m smoke --junitxml=xml_report_backend.xml
  artifacts:
    when: always
    paths:
      - $CI_PROJECT_DIR/integration_tests/allure-results/*
      - $CI_PROJECT_DIR/integration_tests/xml_report_backend.xml
    reports:
      junit: $CI_PROJECT_DIR/integration_tests/xml_report_backend.xml
    expire_in: 1 day
  only:
    - merge_requests
  cache:
    paths:
      - venv/